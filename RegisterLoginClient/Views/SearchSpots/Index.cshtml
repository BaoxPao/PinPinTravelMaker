@section Styles {
    <style>
        .card-img-top {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
    </style>
}
<meta charset="UTF-8">
<title>搜尋景點</title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<div class="container">
    <h1>搜尋景點</h1>
    <div class="input-group mb-3">
        <input type="text" id="searchCity" class="form-control" placeholder="想去哪裡玩?">
        @* 搜尋關鍵字 *@
        <input type="text" id="searchKeyword" class="form-control" placeholder="吃、喝、玩、樂，立即搜尋!">
        <div class="input-group-append">
            <button class="btn btn-primary" type="button" onclick="search()">搜尋</button>
        </div>
    </div>
    <div id="results" class="row"></div>
</div>

@section Scripts
{
    <script>
        var baseAddress = "https://localhost:7280";       //Developr Server //注意結尾沒有斜線!
        //var baseAddress = "https://localhost:xx";       //Staging Server(Testing Server)
        //var baseAddress = "https://localhost:yy";       //Production Server(上線營運Server)

        async function search() {
            const searchCity = document.getElementById('searchCity').value;
            const searchKeyword = document.getElementById('searchKeyword').value;

            // Check if the location is "左營" and no search keyword
            if (searchCity) {
                try {
                    const foodQuery = `${searchCity} 美食`;
                    const attractionsQuery = `${searchCity} 景點`;

                    const [foodResponse, attractionsResponse] = await Promise.all([
                        axios.get(`${baseAddress}/api/SearchSpots/search`, { params: { query: foodQuery } }),
                        axios.get(`${baseAddress}/api/SearchSpots/search`, { params: { query: attractionsQuery } })
                    ]);

                    const foodData = foodResponse.data;
                    const attractionsData = attractionsResponse.data;

                    // 處理和顯示結果
                    const processResults = (results) => {
                        if (Array.isArray(results)) {
                            return results.sort((a, b) => b.user_ratings_total - a.user_ratings_total).slice(0, 3);
                        } else {
                            console.error('data.results 不是數組');
                            return [];
                        }
                    };

                    const sortedFoodResults = processResults(foodData.results);
                    const sortedAttractionsResults = processResults(attractionsData.results);

                    const resultsContainer = document.getElementById('results');
                    resultsContainer.innerHTML = '';

                    // 顯示美食結果
                    if (sortedFoodResults.length > 0) {
                        resultsContainer.innerHTML += `<h2>${searchCity} 美食</h2>`;
                        for (const place of sortedFoodResults) {
                            let photoUrl = '';
                            if (place.photos && place.photos.length > 0) {
                                const photoReference = place.photos[0].photo_reference;
                                photoUrl = await getPhotoUrl(photoReference);
                            }

                            const card = document.createElement('div');
                            card.className = 'col-md-4 mb-3';
                            card.innerHTML = `
                                <div class="card">
                                    ${photoUrl ? `<img src="${photoUrl}" class="card-img-top" width:150px alt="${place.name}">` : '<img src="https://via.placeholder.com/400x200" class="card-img-top" alt="No image available">'}
                                    <div class="card-body">
                                        <h5 class="card-title">${place.name}</h5>
                                        <p class="card-text">${place.formatted_address}</p>
                                        <p class="card-text">評價: ${place.rating} (${place.user_ratings_total} reviews)</p>
                                        <a href="#" class="btn btn-primary" target="_blank">加入願望清單</a>
                                        <a href="#" class="btn btn-primary" target="_blank">詳細資訊</a>
                                    </div>
                                </div>
                            `;
                            resultsContainer.appendChild(card);
                        }
                    }

                    // 顯示景點結果
                    if (sortedAttractionsResults.length > 0) {
                        resultsContainer.innerHTML += `<h2>${searchCity} 景點</h2>`;
                        for (const place of sortedAttractionsResults) {
                            let photoUrl = '';
                            if (place.photos && place.photos.length > 0) {
                                const photoReference = place.photos[0].photo_reference;
                                photoUrl = await getPhotoUrl(photoReference);
                            }

                            const card = document.createElement('div');
                            card.className = 'col-md-4 mb-3';
                            card.innerHTML = `
                                <div class="card">
                                    ${photoUrl ? `<img src="${photoUrl}" class="card-img-top" width:150px alt="${place.name}">` : '<img src="https://via.placeholder.com/400x200" class="card-img-top" alt="No image available">'}
                                    <div class="card-body">
                                        <h5 class="card-title">${place.name}</h5>
                                        <p class="card-text">${place.formatted_address}</p>
                                        <p class="card-text">評價: ${place.rating} (${place.user_ratings_total} reviews)</p>
                                        <a href="#" class="btn btn-primary" target="_blank">加入願望清單</a>
                                        <a href="#" class="btn btn-primary" target="_blank">詳細資訊</a>
                                    </div>
                                </div>
                            `;
                            resultsContainer.appendChild(card);
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            } else {
                console.error('請輸入城市名稱');
            }
        }

        async function getPhotoUrl(photoReference) {
            try {
                const response = await axios.get(`${baseAddress}/api/SearchSpots/GetPhoto`, {
                    params: {
                        photoReference: photoReference
                    }
                });
                return response.data.url;
            } catch (error) {
                console.error('Error:', error);
                return '';
            }
        }

        //在user選定區域後，動態載入該地區[美食]、[景點]、[體驗活動]、[逛街]

        //在user點選地點的[詳細資料]後，以跳出視窗顯示評論、營業時間、價格

        //在user點選地點的[加入願望清單]後，加到DB願望清單中
    </script>
}
