<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag@3.0.1/dist/css/multi-select-tag.css">
<div class="container">
    <div class="row">
        <div class="col-md-4">
            <h1>註冊</h1>
            <form id="registerForm">
                <div class="mb-3">
                    <label for="name" class="form-label">暱稱:</label>
                    <input type="text" class="form-control" id="name" name="name" placeholder="請輸入暱稱，中英皆可" required>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email:</label>
                    <input type="email" class="form-control" id="email" name="email" placeholder="pinpin@com.tw" required>
                </div>
                <div class="mb-3">
                    <label for="phone" class="form-label">電話:</label>
                    <input type="text" class="form-control" id="phone" name="phone" placeholder="09xx-xxx-xxx">
                </div>
                <div class="mb-3">
                    <label for="birthday" class="form-label">生日:</label>
                    <input type="date" class="form-control" id="birthday" name="birthday">
                </div>
                <div class="mb-3">
                    <label for="gender" class="form-label">性别:</label>
                    <select id="gender" name="gender" class="form-select">
                        <option value="0">不公開</option>
                        <option value="1">生理男</option>
                        <option value="2">生理女</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">密碼:</label>
                    <input type="password" class="form-control" id="password" name="password" placeholder="請輸入8-16碼英數字，英文需區分大小寫" required>
                    <input type="checkbox" id="showPassword">顯示密碼</input>

                </div>
                <div class="mb-3">
                    <label for="passwordconfirm" class="form-label">確認密碼:</label>
                    <input type="password" class="form-control" id="passwordconfirm" name="passwordconfirm" placeholder="請再次輸入密碼" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">旅遊喜好:</label>
                    <select name="favor" id="favor" multiple>
                        <option value="1">自然風景</option>
                        <option value="2">人文藝術</option>
                        <option value="3">深度體驗</option>
                        <option value="4">在地美食</option>
                        <option value="5">摘星米其林</option>
                        <option value="6">時尚購物</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="photo" class="form-label">大頭貼照:</label>
                    <input type="file" class="form-control" id="photo" name="photo" accept="image/*">

                </div>
                <div class="mb-3">
                    <img id="photoPreview" src="#" alt="頭像預覽" style="max-width: 200px; max-height: 200px; display: none;">
                </div>
                <button type="submit" class="btn btn-secondary w-100">註冊</button>
            </form>
        </div>
    </div>
</div>

@section Scripts
{
    <script>
        var baseAddress = "https://localhost:7280";
        $(document).ready(function () {
            // 動態加載喜好分類
            //loadFavorCategories();

            $("#showPassword").on("change", function () {
                const passwordField = $("#password");
                const type = this.checked ? "text" : "password";
                passwordField.attr("type", type);
            });

            $("#registerForm").on("submit", async function (event) {
                event.preventDefault();

                const formData = new FormData();

                const name = $("#name").val();
                const email = $("#email").val();
                const phone = $("#phone").val();
                var birthday = $("#birthday").val();
                const gender = $("#gender").val();
                const password = $("#password").val();
                const passwordconfirm = $("#passwordconfirm").val();
                const photo = $("#photo")[0].files[0];
                const selectedFavors = [];
                $('#favor option:selected').each(function () {
                    selectedFavors.push(parseInt($(this).val()));
                });
                formData.append('photo', photo);
                selectedFavors.forEach((favor, index) => {
                    formData.append(`favors[${index}]`, favor); // 將favor作為陣列項傳遞
                });

                // 将多个值以逗号分隔的字符串形式设置给 favor 字段
                //const favor = selectedFavors.join(',');

                if (!validatePassword(password)) {
                    alert('密碼必須為8-16個字符，且包含英文及數字。');
                    return;
                }


                if (password !== passwordconfirm) {
                    alert('請再次確認密碼!');
                    return;
                }

                //若未選擇生日，則預設為"1900-01-01"
                if (!birthday) {
                    birthday = "1900-01-01";
                }
                formData.append('name', name);
                formData.append('email', email);
                formData.append('phone', phone);
                formData.append('birthday', birthday);
                formData.append('gender', gender);
                formData.append('password', password);
                formData.append('passwordconfirm', passwordconfirm);
                //formData.append('favor', favor);
                // if (photo) {
                //     formData.append('photo', photo); // Append photo file to FormData
                // }

                //壓縮圖檔
                const photoFile = document.getElementById("photo").files[0];
                if (photoFile) {
                    const compressedBase64 = await compressAndConvertToBase64(photoFile);
                    formData.append("photo", compressedBase64);
                }

                try {
                    const response = await fetch(`${baseAddress}/api/Auth/Register`, {
                        method: 'POST',
                        //headers: {
                        //     'Content-Type': 'application/json'
                        // },
                        //body: JSON.stringify({ name, email, phone, birthday, gender, password, passwordconfirm })
                        body: formData // Send FormData instead of JSON.stringify
                    });

                    const result = await response.text();
                    alert(result);

                } catch (error) {
                    console.error('Error:', error);
                    alert('註冊失敗，請稍後再試');
                }
            });
        });

        $("#photo").on("change", function () {
            const reader = new FileReader();

            reader.onload = function (e) {
                $("#photoPreview").attr("src", e.target.result);
                $("#photoPreview").css("display", "block"); // 顯示預覽圖片
            };

            // 讀取選擇的圖片檔案
            const file = this.files[0];
            reader.readAsDataURL(file);
        });

        // async function loadFavorCategories() {
        //     try {
        //         const response = await fetch(`${baseAddress}/api/Auth/GetFavorCategories`);
        //         if (!response.ok) {
        //             throw new Error('連線錯誤' + response.statusText);
        //         }
        //         const data = await response.json();
        //         const container = document.getElementById('favorCategoriesContainer');
        //         container.innerHTML = ''

        //         data.forEach(category => {
        //             const checkbox = document.createElement('input');
        //             checkbox.type = 'checkbox';
        //             checkbox.id = 'category_' + category.id;
        //             checkbox.value = category.id;
        //             console.log('Created checkbox:', checkbox.id, checkbox.value);

        //             const label = document.createElement('label');
        //             label.htmlFor = 'category_' + category.id;
        //             label.textContent = category.name;
        //             console.log('Created label:', label.htmlFor, label.textContent);

        //             container.appendChild(checkbox);
        //             container.appendChild(label);
        //             container.appendChild(document.createElement('br'));
        //         });
        //     } catch (error) {
        //         console.error('Error fetching categories:', error);
        //         alert("無法獲得喜好分類: " + error.message);
        //     }
        // }

        //壓縮圖檔
        async function compressAndConvertToBase64(file) {
            const maxLength = 255;  // Adjust this value based on your database column size

            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    let base64String = reader.result.split(',')[1];
                    if (base64String.length > maxLength) {
                        base64String = base64String.substring(0, maxLength);
                    }
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function validatePassword(password) {
            const minLength = 8;
            const maxLength = 16;
            const hasLetter = /[a-zA-Z]/.test(password);
            const hasNumber = /\d/.test(password);

            return password.length >= minLength && password.length <= maxLength && hasLetter && hasNumber;
        }

    </script>
    <script src="https://cdn.jsdelivr.net/gh/habibmhamadi/multi-select-tag@3.0.1/dist/js/multi-select-tag.js"></script>
    <script>
        new MultiSelectTag('favor')  // id
    </script>

}
